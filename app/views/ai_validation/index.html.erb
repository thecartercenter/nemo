<% content_for :title, t("ai_validation.title") %>

<div class="ai-validation-page">
  <div class="page-header">
    <div class="page-header-content">
      <h1><%= t("ai_validation.title") %></h1>
      <div class="page-header-actions">
        <%= link_to t("ai_validation.new_rule"), new_ai_validation_rule_path, class: "btn btn-primary" %>
        <%= link_to t("ai_validation.report"), report_ai_validation_rules_path, class: "btn btn-outline-primary" %>
      </div>
    </div>
  </div>

  <!-- AI Validation Rules Table -->
  <div class="ai-validation-content">
    <% if @rules.any? %>
      <div class="table-responsive">
        <table class="ai-validation-table">
          <thead>
            <tr>
              <th><%= t("ai_validation.name") %></th>
              <th><%= t("ai_validation.rule_type") %></th>
              <th><%= t("ai_validation.ai_model") %></th>
              <th><%= t("ai_validation.threshold") %></th>
              <th><%= t("ai_validation.status") %></th>
              <th><%= t("ai_validation.results") %></th>
              <th><%= t("ai_validation.created_by") %></th>
              <th><%= t("ai_validation.actions") %></th>
            </tr>
          </thead>
          <tbody>
            <% @rules.each do |rule| %>
              <tr>
                <td class="rule-name">
                  <strong><%= rule.name %></strong>
                  <% if rule.description.present? %>
                    <br><small class="text-muted"><%= truncate(rule.description, length: 60) %></small>
                  <% end %>
                </td>
                <td class="rule-type">
                  <span class="rule-type-badge rule-type-<%= rule.rule_type %>">
                    <%= rule.rule_type.humanize %>
                  </span>
                </td>
                <td class="ai-model">
                  <code><%= rule.ai_model %></code>
                </td>
                <td class="threshold">
                  <%= (rule.threshold * 100).round(0) %>%
                </td>
                <td class="status">
                  <% if rule.active? %>
                    <span class="status-badge status-active" id="status-<%= rule.id %>">
                      <i class="fa fa-check-circle"></i>
                      <%= t("ai_validation.active") %>
                    </span>
                  <% else %>
                    <span class="status-badge status-inactive" id="status-<%= rule.id %>">
                      <i class="fa fa-times-circle"></i>
                      <%= t("ai_validation.inactive") %>
                    </span>
                  <% end %>
                </td>
                <td class="results">
                  <% result_count = rule.ai_validation_results.count %>
                  <% if result_count > 0 %>
                    <%= link_to pluralize(result_count, t("ai_validation.result")), ai_validation_rule_path(rule), class: "results-link" %>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td class="created-by">
                  <%= rule.user.name %>
                  <br><small class="text-muted"><%= rule.created_at.strftime("%Y-%m-%d") %></small>
                </td>
                <td class="actions">
                  <div class="action-buttons">
                    <%= link_to t("ai_validation.view"), ai_validation_rule_path(rule), class: "btn btn-sm btn-outline-primary" %>
                    <% if can?(:update, rule) %>
                      <%= link_to t("ai_validation.edit"), edit_ai_validation_rule_path(rule), class: "btn btn-sm btn-outline-secondary" %>
                    <% end %>
                    <% if can?(:update, rule) %>
                      <%= link_to rule.active? ? t("ai_validation.deactivate") : t("ai_validation.activate"),
                                  toggle_active_ai_validation_rule_path(rule),
                                  method: :patch,
                                  remote: true,
                                  class: "btn btn-sm btn-outline-warning toggle-active",
                                  data: { rule_id: rule.id } %>
                    <% end %>
                    <% if can?(:destroy, rule) %>
                      <%= link_to t("ai_validation.delete"),
                                  ai_validation_rule_path(rule),
                                  method: :delete,
                                  class: "btn btn-sm btn-outline-danger",
                                  data: { confirm: t("ai_validation.confirm_delete") } %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="pagination-container">
        <%= will_paginate @rules %>
      </div>
    <% else %>
      <div class="no-rules">
        <div class="no-rules-content">
          <i class="fa fa-robot"></i>
          <h3><%= t("ai_validation.no_rules") %></h3>
          <p><%= t("ai_validation.no_rules_description") %></p>
          <%= link_to t("ai_validation.create_first"), new_ai_validation_rule_path, class: "btn btn-primary" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<%= javascript_doc_ready do %>
  // Handle toggle active via AJAX
  $('.toggle-active').on('ajax:success', function(e, data) {
    var ruleId = $(this).data('rule-id');
    var $statusBadge = $('#status-' + ruleId);
    var $toggleBtn = $(this);
    
    if (data.active) {
      $statusBadge.removeClass('status-inactive').addClass('status-active')
        .html('<i class="fa fa-check-circle"></i> <%= t("ai_validation.active") %>');
      $toggleBtn.text('<%= t("ai_validation.deactivate") %>');
    } else {
      $statusBadge.removeClass('status-active').addClass('status-inactive')
        .html('<i class="fa fa-times-circle"></i> <%= t("ai_validation.inactive") %>');
      $toggleBtn.text('<%= t("ai_validation.activate") %>');
    }
  });
<% end %>

<style>
.ai-validation-page {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

.page-header {
  margin-bottom: 30px;
}

.page-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

.page-header-actions {
  display: flex;
  gap: 10px;
}

.ai-validation-content {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  overflow: hidden;
}

.table-responsive {
  overflow-x: auto;
}

.ai-validation-table {
  width: 100%;
  border-collapse: collapse;
}

.ai-validation-table th {
  background: #f8f9fa;
  padding: 15px 12px;
  text-align: left;
  font-weight: 600;
  color: #333;
  border-bottom: 2px solid #dee2e6;
  white-space: nowrap;
}

.ai-validation-table td {
  padding: 12px;
  border-bottom: 1px solid #dee2e6;
  vertical-align: top;
}

.ai-validation-table tr:hover {
  background: #f8f9fa;
}

.rule-name {
  min-width: 200px;
}

.rule-type-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.8em;
  font-weight: 500;
  text-transform: uppercase;
}

.rule-type-data_quality {
  background: #d4edda;
  color: #155724;
}

.rule-type-anomaly_detection {
  background: #d1ecf1;
  color: #0c5460;
}

.rule-type-consistency_check {
  background: #fff3cd;
  color: #856404;
}

.rule-type-completeness_check {
  background: #f8d7da;
  color: #721c24;
}

.rule-type-format_validation {
  background: #e2e3e5;
  color: #383d41;
}

.rule-type-business_logic {
  background: #d1ecf1;
  color: #0c5460;
}

.rule-type-duplicate_detection {
  background: #d4edda;
  color: #155724;
}

.rule-type-outlier_detection {
  background: #fff3cd;
  color: #856404;
}

.ai-model code {
  background: #f8f9fa;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 0.85em;
  color: #495057;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.8em;
  font-weight: 500;
}

.status-active {
  background: #d4edda;
  color: #155724;
}

.status-inactive {
  background: #f8d7da;
  color: #721c24;
}

.results-link {
  color: #007bff;
  text-decoration: none;
}

.results-link:hover {
  text-decoration: underline;
}

.action-buttons {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  text-decoration: none;
  display: inline-block;
  text-align: center;
}

.btn-primary {
  background: #007bff;
  color: white;
}

.btn-outline-primary {
  background: transparent;
  color: #007bff;
  border: 1px solid #007bff;
}

.btn-outline-secondary {
  background: transparent;
  color: #6c757d;
  border: 1px solid #6c757d;
}

.btn-outline-warning {
  background: transparent;
  color: #ffc107;
  border: 1px solid #ffc107;
}

.btn-outline-danger {
  background: transparent;
  color: #dc3545;
  border: 1px solid #dc3545;
}

.btn-sm {
  padding: 6px 12px;
  font-size: 12px;
}

.text-muted {
  color: #6c757d;
}

.no-rules {
  text-align: center;
  padding: 60px 20px;
}

.no-rules-content i {
  font-size: 4em;
  color: #ccc;
  margin-bottom: 20px;
}

.no-rules-content h3 {
  color: #666;
  margin-bottom: 10px;
}

.no-rules-content p {
  color: #888;
  margin-bottom: 20px;
}

.pagination-container {
  padding: 20px;
  text-align: center;
  border-top: 1px solid #dee2e6;
}

@media (max-width: 768px) {
  .page-header-content {
    flex-direction: column;
    align-items: stretch;
  }
  
  .page-header-actions {
    justify-content: center;
  }
  
  .ai-validation-table {
    font-size: 0.9em;
  }
  
  .ai-validation-table th,
  .ai-validation-table td {
    padding: 8px 6px;
  }
  
  .action-buttons {
    flex-direction: column;
  }
}
</style>
