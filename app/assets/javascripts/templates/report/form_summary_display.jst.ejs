<table class="report_meta">
  <tr>
    <td>
      <%= I18n.t('report/report.mission') %>
    </td>
    <td>
      <%= report.mission.name %>
    </td>
  </tr>
  <tr>
    <td>
      <%= I18n.t('report/report.form') %>
    </td>
    <td>
      <%= report.form.name %>
    </td>
  </tr>
  <tr>
    <td>
      <%= I18n.t('report/report.response_count') %>
    </td>
    <td>
      <%= report.response_count %>
    </td>
  </tr>
  <tr>
    <td>
      <%= I18n.t('report/report.missing_observers') %>
    </td>
    <td>
      <%= report.observers_without_responses.map(function(obs){ return obs.name; }).join(', ') %>
    </td>
  </tr>
</table>

<table class="main">
  <% /*# for now we just have one group */ %>
  <% report.groups[0].clusters.forEach(function(cluster){ %>
    
    <% /*# do cluster header row */ %>
    <tr class="cluster_header">
      <td>#</td>
      <td><%= I18n.t('activerecord.models.question.one') %></td>

      <% if (cluster.display_type == 'flow' || cluster.headers.length > max_cols) { %>
        <td colspan="<%= max_cols %>"><%= cluster.overall_header %></td>
      <% } else { %>
        <% /*# print out each header cell */ %>
        <% cluster.headers.forEach(function(header) { %>
          <td><%= helper.partial('header', {header: header}) %></td>
        <% }); %>

        <% /*# print out blank cells up to max */ %>
        <% for (var i = 0; i < max_cols - cluster.headers.length; i++) { %>
          <td></td>
        <% } %>
      <% } %>
    </tr>

    <% /*# do summary rows */ %>
    <% cluster.summaries.forEach(function(summary) { %>
      <tr>
        <td><%= summary.questioning.rank %></td>
        <td><%= report.question_labels == 'title' ? summary.questioning.name : summary.questioning.code %></td>

        <% /*# if flow type, just print the responses sep'd by commas */ %>
        <% if (cluster.display_type == 'flow') { %>

          <td colspan="<%= max_cols %>">
            <%= summary.items.map(function(item) { return '"' + item.text + '"'; }).join(', ') %>
          </td>

        <% /*# if structured type with less than max_cols, do separate cells */ %>
        <% } else if (cluster.display_type == 'structured' && cluster.headers.length <= max_cols) { %>

          <% summary.items.forEach(function(item) { %>
            <td><%= helper.partial('item', {item: item}) %></td>
          <% }); %>

          <% /*# print out blank cells up to max */ %>
          <% for (var i = 0; i < max_cols - cluster.headers.length; i++) { %>
            <td></td>
          <% } %>

        <% /*# if structured type with more than max_cols, do one big cell */ %>
        <% } else if (cluster.display_type == 'structured' && cluster.headers.length > max_cols) { %>

          <td colspan="<%= max_cols %>">
            <%= summary.items.map(function(item, idx) { return helper.partial('item_with_header', {item: item, header: cluster.headers[idx]}); }).join(', ') %>
          </td>

          <% /*# print out blank cells up to max */ %>
          <% for (var i = 0; i < max_cols - cluster.headers.length; i++) { %>
            <td></td>
          <% } %>

        <% } %>
      </tr>
    <% }); %>
  <% }); %>
</table>